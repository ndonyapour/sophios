steps:
  - cat_pdb:
      in:
        input_structure1: '*protein_fix_side_chain.pdb'
        input_structure2: '*ligand_min.pdb'
        output_structure_path: '&complex_vac.pdb'
  - pdb4amber_run:
      in:
        input_pdb_path: '*complex_vac.pdb'
        output_pdb_path: '&complex_pdb4amber.pdb'
  - leap_gen_top:
      in:
        input_pdb_path: '*complex_pdb4amber.pdb'
        input_lib_path: '*ligand_params.lib'
        input_frcmod_path: '*ligand_params.frcmod'
        output_pdb_path: '&complex_leap.pdb'
        output_top_path: '&complex_leap.prmtop'
        output_crd_path: '&complex_leap.crd'
        config:
          forcefield: ["protein.ff14SB","gaff"]
  - sander_mdrun: # Hydrogen minimization
      in:
        input_top_path: '*complex_leap.prmtop'
        input_crd_path: '*complex_leap.crd'
        input_ref_path: '*complex_leap.crd'
        output_traj_path: '&vac_h_min.crd'
        output_rst_path: '&vac_h_min.rst7'
        output_log_path: '&vac_h_min.log'
        config:
          simulation_type: min_vacuo
          mdin:
            ncyc: 500 # run the steepest descent algorithm for the first ncyc steps
            maxcyc: 1000 # conjugate gradient algorithm for the maxcyce - ncyc steps
            ntpr: 1
            ntr: 1
            ntmin: 1 # For ncyc cycles the steepest descent method is used then conjugate gradient is switched on
            dx0: 0.0001 # The initial step length, default is 0.01
            ntb: 0
            igb: 0
            restraintmask: ":*&!@H="
            restraint_wt: 50.0
            ntwx: 1 # to generate output traj
  - process_minout:
      in:
        input_log_path: '*vac_h_min.log'
        config:
          terms: [ENERGY]
        output_dat_path: vac_h_energy.dat
  - cwl_watcher:
      in:
        file_pattern: '*vac_h_min.log'
        cwl_tool: process_minout
        max_times: '20'
        config:
          in:
            input_log_path: vac_h_min.log
            config:
              terms: ['ENERGY']
            output_dat_path: vac_h_energy.dat
  # # System minimization, with restraints only on the small molecule to
  # # avoid a possible change in position due to protein repulsion.
  - sander_mdrun:
      in:
        input_top_path: '*complex_leap.prmtop'
        input_crd_path: '*vac_h_min.rst7'
        input_ref_path: '*complex_leap.crd'
        output_traj_path: '&vac_m_min.crd'
        output_rst_path: '&vac_m_min.rst7'
        output_log_path: '&vac_m_min.log'
        config:
          simulation_type: min_vacuo
          mdin:
            ncyc: 500 # run the steepest descent algorithm for the first ncyc steps
            maxcyc: 1000 # conjugate gradient algorithm for the maxcyce - ncyc steps
            ntpr: 1
            ntr: 1
            ntmin: 1 # For ncyc cycles the steepest descent method is used then conjugate gradient is switched on
            dx0: 0.0001 # The initial step length, default is 0.01
            ntb: 0
            igb: 0
            restraintmask: ":MOL"
            restraint_wt: 500.0
            ntwx: 1 # to generate output traj
  - process_minout:
      in:
        input_log_path: '*vac_m_min.log'
        output_dat_path: vac_m_min_energy.dat
        config:
          terms: ['ENERGY']
  - cwl_watcher:
      in:
        file_pattern: '*vac_m_min.log'
        cwl_tool: process_minout
        max_times: '20'
        config:
          in:
            input_log_path: vac_m_min.log
            config:
              terms: ['ENERGY']
            output_dat_path: vac_m_min_energy.dat
  - amber_to_pdb:
      in:
        input_top_path: '*complex_leap.prmtop'
        input_crd_path: '*vac_m_min.rst7'
        output_pdb_path: '&complex_min_vac.pdb'

wic:
  graphviz:
    label: Molecular\nModeling
  steps:
    (1, cat_pdb):
      wic:
        graphviz:
          label: Combine Protein\nLigand Coordinates
    (2, pdb4amber_run):
      wic:
        graphviz:
          label: Fix Residue Names\n(pdb4amber)
    (3, leap_gen_top):
      wic:
        graphviz:
          label: Generate Initial\nComplex Topology
    (4, sander_mdrun):
      wic:
        graphviz:
          label: Hydrogen Minimization\nin Vacuum
    (5, process_minout):
      wic:
        graphviz:
          label: 'Analyze & Plot\nEnergy\nTimeseries'
    (6, cwl_watcher):
      wic:
        graphviz:
          label: 'Real-time\nAnalysis'
          style: invis # Make this node invisible
    (7, sander_mdrun):
      wic:
        graphviz:
          label: System minimization\nin Vacuum
    (8, process_minout):
      wic:
        graphviz:
          label: 'Analyze & Plot\nEnergy\nTimeseries'
    (9, cwl_watcher):
      wic:
        graphviz:
          label: 'Real-time\nAnalysis'
          style: invis # Make this node invisible
    (10, amber_to_pdb):
      wic:
        graphviz:
          label: Save Complex\n as PDB
